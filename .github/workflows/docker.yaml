name: Docker

on:
  push:
    branches: "main"
  pull_request:
  workflow_dispatch: # allows you to trigger manually
# concurrency:
#   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
#   cancel-in-progress: true
permissions:
  contents: read
  packages: write
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        clustermanager:
          - htcondor
          # - pbs
          # - sge
          # - slurm
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: docker version
        run: |
          docker version
          docker compose version
      - name: docker compose build
        # shell: bash -l {0}
        run: |
          cd "./ci/${MATRIX_CLUSTERMANAGER:?}"
          cp ../environment.yml environment.yml
          docker compose build
        env:
          MATRIX_CLUSTERMANAGER: ${{ matrix.clustermanager }}
          
      - name: List images
        run: |
          docker ps -a
          docker images
      # TODO: Docker login here
      - name: docker push to GitHub Container Registry
        if: github.event_name != 'pull_request' && matrix.clustermanager != 'htcondor'
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push daskdev/dask-clustermanager:${{ matrix.clustermanager }}

      - name: Publish secondary SGE images to GitHub Container Registry
        if: github.event_name != 'pull_request' && matrix.clustermanager == 'sge'
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push daskdev/dask-clustermanager:${{ matrix.clustermanager }}-slave

      # HTCondor images have composed tags.
      - name: Publish HTCondor images to GitHub Container Registry
        if: github.event_name != 'pull_request' && matrix.clustermanager == 'htcondor'
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push daskdev/dask-clustermanager:${{ matrix.clustermanager }}-submit
          docker push daskdev/dask-clustermanager:${{ matrix.clustermanager }}-execute
