name: Docker
on:
  push:
    branches: "main"
  pull_request:
  workflow_dispatch: # allows you to trigger manually
# concurrency:
#   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
#   cancel-in-progress: true
env:
  MY_GCR_NAMESPACE: 'juliaparallel'
  MY_GCR_IMAGENAME: 'dask-jobqueue-ci-images'
permissions:
  contents: read
  packages: write
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        clustermanager:
          - htcondor
          # - pbs
          # - sge
          # - slurm
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: docker version
        run: |
          which -a docker
          docker version
          docker compose version
      - name: docker compose build
        # shell: bash -l {0}
        run: |
          cd "./ci/${MATRIX_CLUSTERMANAGER:?}"
          cp ../environment.yml environment.yml
          docker compose build
        env:
          MATRIX_CLUSTERMANAGER: ${{ matrix.clustermanager }}
      - name: List images
        run: |
          docker ps -a
          docker images
      # TODO: Docker login here
      # echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      # - name: docker push to GitHub Container Registry
      #   if: github.event_name != 'pull_request' && matrix.clustermanager != 'htcondor'
      #   run: |
      #     docker push "daskdev/dask-clustermanager:${MATRIX_CLUSTERMANAGER:?}"
      #     docker push ghcr.io/<your-GitHub-username>/store:latest
      #     docker build . --tag ghcr.io/<your-GitHub-username>/store:latest
      #   env:
      #     MATRIX_CLUSTERMANAGER: ${{ matrix.clustermanager }}
      # - name: Publish secondary SGE images to GitHub Container Registry
      #   if: github.event_name != 'pull_request' && matrix.clustermanager == 'sge'
      #   run: |
      #     docker push daskdev/dask-clustermanager:${{ matrix.clustermanager }}-slave
      - name: Publish HTCondor images to GitHub Container Registry
        # HTCondor images have composed tags.
        # if: github.event_name != 'pull_request' && matrix.clustermanager == 'htcondor'
        run: |
          docker push "ghcr.io/${MY_GCR_NAMESPACE:?}/${MY_GCR_IMAGENAME:?}:${MATRIX_CLUSTERMANAGER:?}-submit"
          docker push "ghcr.io/${MY_GCR_NAMESPACE:?}/${MY_GCR_IMAGENAME:?}:${MATRIX_CLUSTERMANAGER:?}-execute"
        env:
          MATRIX_CLUSTERMANAGER: ${{ matrix.clustermanager }}
          
